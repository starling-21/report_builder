{% extends 'reports/base.html' %}

{#loads custom tags#}
{% load common %}

{% block extra_head %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/i18n/ru.js"></script>
{% endblock %}

{#TEST include#}
{#{% include "django/forms/widgets/input.html" %}#}


{% block content %}
    <p><u><i>Всі посередники:</i></u></p>


    <form method="POST">{% csrf_token %}
        <hr>
        <hr>
        {% for servicemember in serviceman_chain %}
            {# editing chain member, show input field for new chain member in chain members line #}
            {% if swap_id == servicemember.id and swap_presence is None %}
                {% set swap_presence = True %}
                Заміна посередника ({{ servicemember.rank.name }} {{ servicemember }}) на папєрєдніка:
                <br>
                <select name="swap_id"></select>
{#                <select title="rank-fname-lname" name="swap_id"></select>#}
{#                <select title="rank-lname-fname" name="swap_id"></select>#}
{#                <select title="fname-lname" name="swap_id"></select>#}
{#                <select title="lname-fname" name="swap_id"></select>#}



                <button type="submit" class="btn btn-light btn-sm" name="submit_new_id" value="{{ servicemember.id }}">
                    <span class="fas fa-check-square"></span> Ok
                </button> {#submit chain member id editing button#}


            {% else %}
                {# show NORMAL CHAIN member line #}
                {{ servicemember.rank.name }} {{ servicemember }}
                <br>{{ servicemember.position }}
                <br>
                {% if not forloop.first %}
                    <button type="submit" class="btn btn-light btn-sm" name="edit_chain_id"
                            value="{{ servicemember.id }}"><span class="fas fa-edit"></span>
                    </button>
                {% endif %}
                {% if not forloop.first and not forloop.last %}
                    <button type="submit" class="btn btn-light btn-sm" name="remove_chain_id"
                            value="{{ servicemember.id }}"
                            onclick="return window.confirm('Видалити посередника?\n{{ servicemember.rank.name }} {{ servicemember }} ')">
                        <span class="far fa-trash-alt"></span>
                    </button>
                {% endif %}
            {% endif %}
            <hr>
            <hr>
        {% endfor %}

        <input type="submit" class="btn btn-info" name="submit_chain_editing" value="Далі"/>

    </form>

{% endblock %}

{#block submitting form by pressing Enter button#}
{% block js_scripts %}
    <script>

        $(document).ready(function () {

            // defint dynamic url function for SELECT tag
            //var search_name_format = '';
            //var dynamic_url_function = function getURL() {
            //    return '/search_member/' + search_name_format;
            //}

            // Initialize select2
            var csrf_token = '{{ csrf_token }}';
            $('select').select2({
                placeholder: "Пошук (Імена та Прізвища з Великої літери)",
                allowClear: true,
                language: "ru",
                delay: 250,
                width: '400px',

                ajax: {
                    csrfmiddlewaretoken: csrf_token,
                    {#url: dynamic_url_function,#}
                    url: '/search_member/',
                    method: 'POST',
                    dataType: 'json',
                    // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
                    data: function (params) {
                        var query = {
                            csrfmiddlewaretoken: csrf_token,
                            filter_param: params.term,
                            name_format: $(this).attr('title')
                        }
                        return query;
                    },
                    processResults: function (data) {
                        // Transforms the top-level key of the response object from 'items' to 'results'
                        //console.log("success")
                        console.log(data)
                        return {
                            results: data
                        };
                    }
                }
                //}).on('select2:opening', function (e) {
                //    search_name_format = $(this).attr('title');
                //}
            });
        });

    </script>
{% endblock %}
{% extends 'reports/base.html' %}

{#loads custom tags#}

{% block extra_head %}
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/css/select2.min.css" rel="stylesheet"/>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.12/dist/js/select2.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/select2/4.0.3/js/i18n/ru.js"></script>
{% endblock %}


{% block content %}
    <p><h3>Всі посередники:</h3></p>
    <hr>

    <form method="POST">{% csrf_token %}
        {% for servicemember in serviceman_chain %}
            <div class="row left-bordered-row bg-light rounded m-3">
                {% if swap_id == servicemember.id %}
                    <div class="col-12">
                        <select name="swap_id"></select>
                        <button type="submit" class="btn btn-secondary btn-sm" name="submit_new_id"
                                value="{{ servicemember.id }}">
                            замінити<i class="fas fa-exchange-alt m-1"></i>
                        </button>
                        {#submit chain member id editing button#}
                    </div>
                {# end of editing chain member #}
                {% else %}
                    {# member representation block #}
                    <div class="col-11">
                        {{ servicemember.rank.name }} {{ servicemember }}
                        <br>{{ servicemember.position }}
                    </div>
                    {# end of member representation block #}

                    {# edit buttons group#}
                    <div class="col-1 d-flex justify-content-end align-items-center pr-0">
                        {% if not forloop.first %}
                            <div data-toggle="tooltip" data-placement="top" title="редагувати">
                                <button type="submit" class="btn btn-light btn-sm text-info mr-1" name="edit_chain_id"
                                        value="{{ servicemember.id }}"><span class="fas fa-edit fa-2x"></span>
                                </button>
                            </div>
                        {% endif %}

                        {% if not forloop.first and not forloop.last %}
                            <div data-toggle="tooltip" data-placement="top" title="видалити">
                                <button type="submit" class="btn btn-light btn-sm text-danger mr-1" name="remove_chain_id"
                                        value="{{ servicemember.id }}"
                                        onclick="return window.confirm('Видалити посередника?\n{{ servicemember.rank.name }} {{ servicemember }} ')">
                                    <span class="far fa-trash-alt fa-2x"></span>
                                </button>
                            </div>
                        {% endif %}
                    </div>
                    {# end of edit buttons group#}

                {% endif %}
            </div>

        {% endfor %}


        {% if swap_id is None %}
            <button class="btn btn-bordered-primary bg-secondary float-right text-light m-3"
                    type="submit" name="submit_chain_editing">
                <span>Далі</span><i class="fas fa-angle-double-right ml-2"></i>
            </button>
        {% endif %}

    </form>


{% endblock %}











{#block submitting form by pressing Enter button#}
{% block js_scripts %}
    <script>

        $(document).ready(function () {

            // Initialize select2
            var csrf_token = '{{ csrf_token }}';
            $('select').select2({
                placeholder: "Пошук (Імена та Прізвища з Великої літери)",
                allowClear: true,
                language: "ru",
                delay: 250,
                width: '400px',

                ajax: {
                    csrfmiddlewaretoken: csrf_token,
                    url: '/search_member/',
                    method: 'POST',
                    dataType: 'json',
                    // Additional AJAX parameters go here; see the end of this chapter for the full code of this example
                    data: function (params) {
                        var query = {
                            csrfmiddlewaretoken: csrf_token,
                            filter_param: params.term,
                            name_format: $(this).attr('title')
                        }
                        return query;
                    },
                    processResults: function (data) {
                        // Transforms the top-level key of the response object from 'items' to 'results'
                        //console.log("success")
                        console.log(data)
                        return {
                            results: data
                        };
                    }
                }
            });
        });

    </script>
{% endblock %}